{% extends 'base.html' %}
{% load static %}
{% load render_proof %}

{% block title %}

{% endblock %}
{% block css %}
  <link rel="stylesheet" href="{% static 'css/tasks/view_task_details.css' %}" />
  <link rel="stylesheet" href="{% static 'css/forms/input_form.css' %}" />
{% endblock %}
{% block content %}
  <section class="container py-5">
    <div class="mb-3">
      <a href="{% url 'user_task_overview' %}" class="btn btn-link p-0 text-decoration-none"><i class="bi bi-arrow-left-circle-fill me-2 align-middle"></i> Back to Overview</a>
    </div>

    <div class="row g-4">
      <!-- Details -->
      <div class="col-lg-7">
        <article class="card">
          <div class="card-body">
            <h1 class="h3 mb-3">Task Details</h1>
            <h2 class="h4 mb-2">{{ task.title }}</h2>

            <dl class="row">
              <dt class="col-sm-5">Description</dt>
              <dd class="col-sm-7">{{ task.description }}</dd>

              <dt class="col-sm-5">Task will be repeated</dt>

              <dd class="col-sm-7">
                {% if task.repetition %}
                  Yes
                {% else %}
                  No
                {% endif %}
              </dd>

              <dt class="col-sm-5">Checkup Interval</dt>
              <dd class="col-sm-7">{{ task.interval }}</dd>

              <dt class="col-sm-5">Fee for Failure</dt>
              <dd class="col-sm-7">{{ task.fee }}â‚¬</dd>

              <dt class="col-sm-5">Points for Completion</dt>
              <dd class="col-sm-7">{{ task.points }} Points</dd>

              {% if task.completed == True %}
                <dt class="col-sm-5">Task done successfully</dt>
                <dd class="col-sm-7">Yes</dd>
              {% endif %}
            </dl>
            <button type="button" class="btn btn-danger {% if task.checkup_state %}disabled{% endif %}" data-bs-toggle="modal" data-bs-target="#deleteTaskModal"><i class="bi bi-trash3-fill"></i></button>
            <div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskLabel" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                  <div class="modal-header">
                    <h5 class="modal-title" id="deleteTaskLabel">Delete task?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>

                  <div class="modal-body">
                    <p class="mb-0">
                      Are you sure you want to delete
                      <strong>{{ task.title }}</strong>? This action cannot be undone and there will be no points awarded.
                    </p>
                  </div>

                  <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>

                    <form method="post" action="{% url 'delete_task' task.id %}">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-danger">Yes, delete</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </article>
      </div>

      <!-- Proof & Actions -->
      <div class="col-lg-5">
        {% if not perms.tasks.mark_done %}
          <section class="card mb-2">
            <div class="card-body">
              <h3 class="h5 mb-3">Upload Proof</h3>
              {% if not task_checkup %}
                <form method="post" enctype="multipart/form-data">
                  {% csrf_token %}
                  {# Comments #}
                  <div class="mb-3">
                    <label for="{{ check_form.comments.id_for_label }}" class="form-label">Comments:</label>
                    {{ check_form.comments }}
                    {% if check_form.comments.errors %}
                      <div class="invalid-feedback d-block">{{ check_form.comments.errors|striptags }}</div>
                    {% endif %}
                  </div>

                  {# Image upload: "Text: [Button]" #}
                  <div class="mb-3">
                    <label for="{{ check_form.image.id_for_label }}" class="form-label">{{ check_form.image.help_text|default:'Upload an image for this checkup' }}:</label>
                    {{ check_form.image }}
                    <div class="form-text">{{ check_form.image.label }}</div>
                    {% if check_form.image.errors %}
                      <div class="invalid-feedback d-block">{{ check_form.image.errors|striptags }}</div>
                    {% endif %}
                  </div>

                  {# Video upload: "Text: [Button]" #}
                  <div class="mb-3">
                    <label for="{{ check_form.video.id_for_label }}" class="form-label">{{ check_form.video.help_text|default:'Upload a video for this checkup' }}:</label>
                    {{ check_form.video }}
                    <div class="form-text">{{ check_form.video.label }}</div>
                    {% if check_form.video.errors %}
                      <div class="invalid-feedback d-block">{{ check_form.video.errors|striptags }}</div>
                    {% endif %}
                  </div>

                  {# Text file upload: "Text: [Button]" #}
                  <div class="mb-3">
                    <label for="{{ check_form.text_file.id_for_label }}" class="form-label">{{ check_form.text_file.help_text|default:'Upload a text file for this checkup' }}:</label>
                    {{ check_form.text_file }}
                    <div class="form-text">{{ check_form.text_file.label }}</div>
                    {% if check_form.text_file.errors %}
                      <div class="invalid-feedback d-block">{{ check_form.text_file.errors|striptags }}</div>
                    {% endif %}
                  </div>

                  {# Audio upload: "Text: [Button]" #}
                  <div class="mb-3">
                    <label for="{{ check_form.audio_file.id_for_label }}" class="form-label">{{ check_form.audio_file.help_text|default:'Upload an audio file for this checkup' }}:</label>
                    {{ check_form.audio_file }}
                    <div class="form-text">{{ check_form.audio_file.label }}</div>
                    {% if check_form.audio_file.errors %}
                      <div class="invalid-feedback d-block">{{ check_form.audio_file.errors|striptags }}</div>
                    {% endif %}
                  </div>

                  <div class="d-grid d-sm-flex gap-2">
                    <button type="submit" name="proof_upload" class="btn btn-primary">Upload proof</button>
                  </div>
                </form>
              {% else %}
                <div class="alert alert-info mb-0" role="alert">You already uploaded proof for that task.</div>
              {% endif %}
            </div>
          </section>
        {% endif %}
        {% if task_checkup %}
          <section class="card">
            <div class="card-body d-flex flex-column align-center justify-center">
              {% if task_checkup.comments %}
                <h4 class="h6 mb-2">Comments</h4>
                <p class="mb-3">{{ task_checkup.comments }}</p>
              {% endif %}

              {% if task_checkup.image %}
                <h4 class="h6 mb-2">Uploaded proof Image</h4>
                <div class="mb-3">{{ task_checkup.image|render_image }}</div>
              {% endif %}

              {% if task_checkup.video %}
                <h4 class="h6 mb-2">Uploaded proof Video</h4>
                <div class="mb-3">{{ task_checkup.video|render_video }}</div>
              {% endif %}

              {% if task_checkup.text_file %}
                <h4 class="h6 mb-2">Uploaded proof Text File</h4>
                <div class="mb-3">{{ task_checkup.text_file|render_textfile }}</div>
              {% endif %}

              {% if task_checkup.audio_file %}
                <h4 class="h6 mb-2">Uploaded proof Audio File</h4>
                <div class="mb-3">{{ task_checkup.audio_file|render_audio }}</div>
              {% endif %}

              {% if perms.tasks.mark_done %}
                <form method="post" class="mb-2 mt-2">
                  {% csrf_token %}
                  <div class="d-grid d-sm-flex gap-2">
                    <button type="submit" name="done_checkbox" class="btn btn-primary">Mark as Done</button>
                  </div>
                </form>
                <form method="post">
                  {% csrf_token %}
                  <div class="d-grid d-sm-flex gap-2">
                    <button type="submit" name="failed_checkbox" class="btn btn-primary">Mark as Failed</button>
                  </div>
                </form>
              {% endif %}
            </div>
          </section>
        {% endif %}
      </div>
    </div>
  </section>
{% endblock %}
